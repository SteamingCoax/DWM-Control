<!DOCTYPE html>
<html>
<head>
    <title>DFU Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .debug-section h3 { margin-top: 0; color: #333; }
        button { padding: 10px 15px; margin: 5px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a9e; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>üîß DFU Debug Test Page</h1>
    
    <div class="debug-section">
        <h3>1. API Availability Test</h3>
        <button onclick="testAPI()">Test electronAPI Availability</button>
        <div id="api-output" class="output"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. DFU Device Detection Test</h3>
        <button onclick="testDFUDetection()">Scan for DFU Devices</button>
        <button onclick="testDFUDetectionVerbose()">Verbose DFU Scan</button>
        <div id="dfu-output" class="output"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. Main App Integration Test</h3>
        <button onclick="refreshMainApp()">Refresh Main App Devices</button>
        <button onclick="checkMainAppState()">Check Main App State</button>
        <div id="main-output" class="output"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const output = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testAPI() {
            clear('api-output');
            log('api-output', 'Testing electronAPI availability...');
            
            try {
                if (typeof window.electronAPI === 'undefined') {
                    log('api-output', '‚ùå window.electronAPI is not available', 'error');
                    log('api-output', 'This usually means preload.js is not loaded or contextBridge failed', 'error');
                    return;
                }
                
                log('api-output', '‚úÖ window.electronAPI is available', 'success');
                
                const api = window.electronAPI;
                log('api-output', 'Available methods:');
                Object.keys(api).forEach(key => {
                    log('api-output', `  - ${key}: ${typeof api[key]}`);
                });
                
                if (typeof api.getDfuDevices !== 'function') {
                    log('api-output', '‚ùå getDfuDevices method not found!', 'error');
                } else {
                    log('api-output', '‚úÖ getDfuDevices method is available', 'success');
                }
                
            } catch (error) {
                log('api-output', `‚ùå Error testing API: ${error.message}`, 'error');
            }
        }

        async function testDFUDetection() {
            clear('dfu-output');
            log('dfu-output', 'Starting DFU device detection...');
            
            try {
                if (typeof window.electronAPI === 'undefined' || typeof window.electronAPI.getDfuDevices !== 'function') {
                    log('dfu-output', '‚ùå electronAPI.getDfuDevices not available', 'error');
                    return;
                }
                
                log('dfu-output', 'Calling window.electronAPI.getDfuDevices()...');
                const result = await window.electronAPI.getDfuDevices();
                
                log('dfu-output', 'Raw result received:');
                log('dfu-output', JSON.stringify(result, null, 2));
                
                if (result.success) {
                    log('dfu-output', `‚úÖ Success! Found ${result.devices.length} device(s)`, 'success');
                    result.devices.forEach((device, index) => {
                        log('dfu-output', `Device ${index + 1}: ${device.vid}:${device.pid} (${device.serial})`, 'success');
                    });
                } else {
                    log('dfu-output', `‚ùå Failed: ${result.error}`, 'error');
                    if (result.output) {
                        log('dfu-output', 'Raw dfu-util output:', 'warning');
                        log('dfu-output', result.output);
                    }
                }
                
            } catch (error) {
                log('dfu-output', `‚ùå Exception: ${error.message}`, 'error');
                log('dfu-output', error.stack);
            }
        }

        async function testDFUDetectionVerbose() {
            clear('dfu-output');
            log('dfu-output', 'Starting verbose DFU detection test...');
            
            try {
                const result = await window.electronAPI.getDfuDevices();
                
                log('dfu-output', '=== VERBOSE DFU TEST RESULTS ===');
                log('dfu-output', `Success: ${result.success}`);
                log('dfu-output', `Error: ${result.error || 'none'}`);
                log('dfu-output', `Device count: ${result.devices ? result.devices.length : 'undefined'}`);
                log('dfu-output', `Needs setup: ${result.needsSetup || false}`);
                log('dfu-output', `Windows help: ${result.windowsHelp || false}`);
                
                if (result.output) {
                    log('dfu-output', '\n--- Raw dfu-util output ---');
                    log('dfu-output', result.output);
                    log('dfu-output', '--- End raw output ---\n');
                    
                    // Test parsing manually
                    const lines = result.output.split('\n');
                    const dfuLines = lines.filter(line => line.includes('Found DFU'));
                    log('dfu-output', `Lines containing "Found DFU": ${dfuLines.length}`);
                    dfuLines.forEach((line, index) => {
                        log('dfu-output', `DFU Line ${index + 1}: ${line}`);
                    });
                }
                
                if (result.devices) {
                    log('dfu-output', '\n--- Parsed devices ---');
                    result.devices.forEach((device, index) => {
                        log('dfu-output', `Device ${index}:`, 'success');
                        log('dfu-output', `  VID: ${device.vid}`);
                        log('dfu-output', `  PID: ${device.pid}`);
                        log('dfu-output', `  Serial: ${device.serial}`);
                        log('dfu-output', `  Name: ${device.name || 'none'}`);
                        log('dfu-output', `  Alt: ${device.alt || 'none'}`);
                        log('dfu-output', `  Description: ${device.description || 'none'}`);
                    });
                }
                
            } catch (error) {
                log('dfu-output', `‚ùå Exception in verbose test: ${error.message}`, 'error');
            }
        }

        async function refreshMainApp() {
            clear('main-output');
            log('main-output', 'Attempting to refresh main app...');
            
            try {
                // Check if we're in the main app context
                if (typeof window.app !== 'undefined' && typeof window.app.refreshDfuDevices === 'function') {
                    log('main-output', 'Found main app context, calling refreshDfuDevices()...');
                    await window.app.refreshDfuDevices();
                    log('main-output', '‚úÖ Main app refresh completed', 'success');
                } else {
                    log('main-output', '‚ö†Ô∏è Main app context not found', 'warning');
                    log('main-output', 'This debug page should be opened within the main app');
                }
            } catch (error) {
                log('main-output', `‚ùå Error refreshing main app: ${error.message}`, 'error');
            }
        }

        async function checkMainAppState() {
            clear('main-output');
            log('main-output', 'Checking main app state...');
            
            try {
                // Check DOM elements
                const deviceCombo = document.getElementById('device-combo');
                const refreshBtn = document.getElementById('refresh-devices-btn');
                
                log('main-output', `Device combo found: ${!!deviceCombo}`);
                if (deviceCombo) {
                    log('main-output', `Device combo options: ${deviceCombo.options.length}`);
                    for (let i = 0; i < deviceCombo.options.length; i++) {
                        log('main-output', `  Option ${i}: ${deviceCombo.options[i].text}`);
                    }
                }
                
                log('main-output', `Refresh button found: ${!!refreshBtn}`);
                if (refreshBtn) {
                    log('main-output', `Refresh button disabled: ${refreshBtn.disabled}`);
                }
                
                // Check global app state
                if (typeof window.app !== 'undefined') {
                    log('main-output', '‚úÖ Main app object found', 'success');
                    log('main-output', `Selected device: ${window.app.selectedDevice ? 'yes' : 'none'}`);
                    if (window.app.selectedDevice) {
                        log('main-output', `Device info: ${JSON.stringify(window.app.selectedDevice)}`);
                    }
                } else {
                    log('main-output', '‚ö†Ô∏è Main app object not found', 'warning');
                }
                
            } catch (error) {
                log('main-output', `‚ùå Error checking main app state: ${error.message}`, 'error');
            }
        }

        // Auto-run API test on load
        window.addEventListener('load', () => {
            setTimeout(testAPI, 1000);
        });
    </script>
</body>
</html>
